name: Translate Blog Posts

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Select Domain"
        required: true
        type: choice
        default: blog.conholdate.com
        options:
          - blog.aspose.com
          - blog.groupdocs.com
          - blog.conholdate.com
          - blog.aspose.cloud
          - blog.groupdocs.cloud
          - blog.conholdate.cloud

      product:
        description: "Select Product (Optional)"
        required: false
        type: choice
        default: "ALL"
        options:
          # Aspose
          - "ALL"   # empty â†’ optional
          - Aspose.3D
          - Aspose.BarCode
          - Aspose.CAD
          - Aspose.Cells
          - Aspose.Diagram
          - Aspose.Drawing
          - Aspose.Email
          - Aspose.Finance
          - Aspose.Font
          - Aspose.GIS
          - Aspose.HTML
          - Aspose.Imaging
          - Aspose.Note
          - Aspose.OCR
          - Aspose.OMR
          - Aspose.Page
          - Aspose.PDF
          - Aspose.PSD
          - Aspose.PUB
          - Aspose.Slides
          - Aspose.SVG
          - Aspose.Tasks
          - Aspose.Tex
          - Aspose.Total
          - Aspose.Words
          - Aspose.ZIP
          - Aspose.Medical

          # Aspose Cloud
          - Aspose.3D Cloud
          - Aspose.BarCode Cloud
          - Aspose.CAD Cloud
          - Aspose.Cells Cloud
          - Aspose.Diagram Cloud
          - Aspose.Email Cloud
          - Aspose.HTML Cloud
          - Aspose.Imaging Cloud
          - Aspose.OCR Cloud
          - Aspose.OMR Cloud
          - Aspose.PDF Cloud
          - Aspose.Slides Cloud
          - Aspose.Tasks Cloud
          - Aspose.Total Cloud
          - Aspose.Words Cloud

          # GroupDocs
          - GroupDocs.Annotation
          - GroupDocs.Assembly
          - GroupDocs.Classification
          - GroupDocs.Comparison
          - GroupDocs.Conversion
          - GroupDocs.Editor
          - GroupDocs.Markdown
          - GroupDocs.Merger
          - GroupDocs.Metadata
          - GroupDocs.Parser
          - GroupDocs.Redaction
          - GroupDocs.Search
          - GroupDocs.Signature
          - GroupDocs.Total
          - GroupDocs.Viewer
          - GroupDocs.Watermark

          # GroupDocs Cloud
          - GroupDocs.Annotation Cloud
          - GroupDocs.Assembly Cloud
          - GroupDocs.Classification Cloud
          - GroupDocs.Comparison Cloud
          - GroupDocs.Conversion Cloud
          - GroupDocs.Editor Cloud
          - GroupDocs.Merger Cloud
          - GroupDocs.Metadata Cloud
          - GroupDocs.Parser Cloud
          - GroupDocs.Rewriter Cloud
          - GroupDocs.Signature Cloud
          - GroupDocs.Total Cloud
          - GroupDocs.Translation Cloud
          - GroupDocs.Viewer Cloud
          - GroupDocs.Watermark Cloud

          # Conholdate
          - Conholdate.Total

          # Conholdate Cloud
          - Conholdate.Total Cloud

      author:
        description: "Author Name (Optional)"
        required: false
        type: string
        default: "ALL"   # empty â†’ optional

      limit:
        description: "Limit Number of Posts to Translate (Optional)"
        required: false
        type: number
        default: "ALL"   # 0 or blank means no limit

jobs:
  detect-missing-translations:
    runs-on: ubuntu-latest

    steps:
      #############################################################
      # 0. CHECKOUT THIS REPO (blog-translation-tools)
      #############################################################
      - name: Checkout blog-translation-tools
        uses: actions/checkout@v4

      #############################################################
      # 1. CHECKOUT TARGET REPO (blog.groupdocs.com)
      #############################################################
      - name: Set repository based on domain
        id: maprepo
        run: |
          if [ "${{ inputs.domain }}" = "blog.aspose.com" ]; then
            echo "REPO=aspose/aspose-blog" >> $GITHUB_ENV


          elif [ "${{ inputs.domain }}" = "blog.groupdocs.com" ]; then
            echo "REPO=groupdocs/groupdocs-blog" >> $GITHUB_ENV


          elif [ "${{ inputs.domain }}" = "blog.conholdate.com" ]; then
            echo "REPO=conholdate/conholdate-blog" >> $GITHUB_ENV
          
          elif [ "${{ inputs.domain }}" = "blog.aspose.cloud" ]; then
            echo "REPO=aspose-cloud/aspose-cloud-blog" >> $GITHUB_ENV


          elif [ "${{ inputs.domain }}" = "blog.groupdocs.cloud" ]; then
            echo "REPO=groupdocs-cloud/groupdocs-cloud-blog" >> $GITHUB_ENV
          
          elif [ "${{ inputs.domain }}" = "blog.conholdate.cloud" ]; then
            echo "REPO=conholdate-cloud/blog.conholdate.cloud" >> $GITHUB_ENV

          else
            echo "Unknown domain!"; exit 1
          fi

          echo "REPO_PATH=blog-checkedout-repo" >> $GITHUB_ENV

          echo "Selected repository: $REPO"
          echo "Checkout directory: $REPO_PATH"


      - name: Checkout Selected Blogs REPO
        uses: actions/checkout@v4
        with:
          repository: ${{ env.REPO }}
          token: ${{ secrets.PAT_GITHUB_SK }}
          path: ${{ env.REPO_PATH }}
          fetch-depth: 0

      #############################################################
      # 2. SETUP PYTHON
      #############################################################
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      #############################################################
      # 3. Create Virtual Environment and Install Python Dependencies
      #############################################################
      - name: Print all environment variables
        run: env
      
      - name: Create virtual environment
        run: python -m venv .venv
      
      - name: Activate venv and install dependencies
        run: |
          echo ==============================
          source .venv/bin/activate
          echo Workspace: $GITHUB_WORKSPACE
          echo ==============================
          echo "GitHub workspace: ${{ github.workspace }}"
          # ls -R .
          echo ==============================
          pip install --upgrade pip
          pip install -r tools/detect_missing_translation/requirements.txt
          echo ==============================

      #############################################################
      # 4. RUN TRANSLATION SCRIPT
      #############################################################
      - name: Run translation detection
        env:
          TARGET_REPO: blog-checkedout-com/content/
          GOOGLE_CREDENTIALS_JSON_SK: ${{secrets.GOOGLE_CREDENTIALS_JSON_SK}}
        run: |
          source .venv/bin/activate
          
          # ============= Build arguments dynamically =============
          
          args=()
          # Domain (always required)
          args+=("--domain" "${{ inputs.domain }}")

          # Key
          args+=("--key" "${{ secrets.PROFESSIONALIZE_LLM_BLOGS_TEAM }}")

          # Product
          if [[ -n "${{ inputs.product }}" && "${{ inputs.product }}" != "ALL" ]]; then
            args+=("--product" "${{ inputs.product }}")
          fi

          # Author (skip if empty or ALL)
          if [[ -n "${{ inputs.author }}" && "${{ inputs.author }}" != "ALL" ]]; then
            args+=("--author" "${{ inputs.author }}")
          fi

          # Limit
          if [[ -n "${{ inputs.limit }}" && "${{ inputs.limit }}" != "ALL" ]]; then
            args+=("--limit" "${{ inputs.limit }}")
          fi

          # Run the python script safely
          python tools/translation_agent/scan_missing_translations.py "${args[@]}"

      #############################################################
      # 5. COMMIT CHANGES BACK TO TARGET REPO
      #############################################################
      # - name: Commit & Push translation files
      #   uses: stefanzweifel/git-auto-commit-action@v5
      #   with:
      #     commit_message: "Auto: Add missing translation files"
      #     branch: main
      #     repository: blog-groupdocs-com
      #     commit_user_name: "GitHub Actions Bot"
      #     commit_user_email: "actions@github.com"
      #     token: ${{ secrets.GH_PAT }}

      #############################################################
      # 5. COMMIT CHANGES BACK TO TARGET REPO & CREATE PR
      #############################################################
      
      # 5.1 Commit the newly created files
      - name: Prepare Git for Commit
        id: prep
        run: |
          # Move into the checked-out directory
          cd ${{ env.REPO_PATH }}
          
          # Configure Git user for the commit (This is the only necessary manual config)
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # Add all new or modified translation files to the staging area
          # The action will commit these changes later.
          git add content/
          
          # Check if there are any staged changes to commit
          if [ -n "$(git diff --cached --name-only)" ]; then
            echo "COMMITTED_CHANGES=true" >> $GITHUB_ENV
          else
            echo "No translation changes detected. Skipping PR creation."
            echo "COMMITTED_CHANGES=false" >> $GITHUB_ENV
          fi
          
      
      # 5.2 Create the Pull Request using Peter Evans' Action
      - name: Create Pull Request
        if: env.COMMITTED_CHANGES == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_GITHUB_SK }} 
          
          # The path must be set to the checked out repository directory
          path: ${{ env.REPO_PATH }} 
          
          # The branch name the action will create and push
          branch: blogteam/translation-detection-${{ github.run_id }} 
          
          # The base branch (where the changes will be merged into)
          base: main 
          
          # The commit message uses the staged changes from the previous step
          commit-message: "Auto: Add missing translation files for ${{ inputs.domain }}"
          title: "ðŸ¤– Missing Translations for ${{ inputs.domain }}"
          body: |
            Automatically generated PR containing missing translation files.
            
            * Triggered by: **${{ github.actor }}**
            * Domain: **${{ inputs.domain }}**
            * Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}