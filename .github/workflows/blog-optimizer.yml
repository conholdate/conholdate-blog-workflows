name: Daily Blog Optimizer

on:
  schedule:
    - cron: "30 2 * * *" # Daily at 02:30 UTC with in-job jitter
  workflow_dispatch:
    inputs:
      skip_jitter:
        description: "Skip random delay (useful for manual testing)"
        type: boolean
        default: true
      run_conholdate:
        description: "Run conholdate"
        type: boolean
        default: true
      run_conholdate_cloud:
        description: "Run conholdate-cloud"
        type: boolean
        default: true
      run_aspose:
        description: "Run aspose"
        type: boolean
        default: true
      run_aspose_cloud:
        description: "Run aspose-cloud"
        type: boolean
        default: true
      run_groupdocs:
        description: "Run groupdocs"
        type: boolean
        default: true
      run_groupdocs_cloud:
        description: "Run groupdocs-cloud"
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  optimize:
    name: ${{ matrix.brand }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - brand: conholdate
            repo: conholdate/conholdate-blog
            path: conholdate-blog
            default_branch: main
            input_name: run_conholdate
          - brand: conholdate-cloud
            repo: conholdate-cloud/blog.conholdate.cloud
            path: blog.conholdate.cloud
            default_branch: main
            input_name: run_conholdate_cloud
          - brand: aspose
            repo: Aspose/aspose-blog
            path: aspose-blog
            default_branch: master
            input_name: run_aspose
          - brand: aspose-cloud
            repo: aspose-cloud/aspose-cloud-blog
            path: aspose-cloud-blog
            default_branch: master
            input_name: run_aspose_cloud
          - brand: groupdocs
            repo: groupdocs/groupdocs-blog
            path: groupdocs-blog
            default_branch: master
            input_name: run_groupdocs
          - brand: groupdocs-cloud
            repo: groupdocs-cloud/groupdocs-cloud-blog
            path: groupdocs-cloud-blog
            default_branch: master
            input_name: run_groupdocs_cloud

    steps:
      - name: Decide whether to run this brand
        id: select
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "run_this=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          case "${{ matrix.input_name }}" in
            run_conholdate)
              value="${{ inputs.run_conholdate }}"
              ;;
            run_conholdate_cloud)
              value="${{ inputs.run_conholdate_cloud }}"
              ;;
            run_aspose)
              value="${{ inputs.run_aspose }}"
              ;;
            run_aspose_cloud)
              value="${{ inputs.run_aspose_cloud }}"
              ;;
            run_groupdocs)
              value="${{ inputs.run_groupdocs }}"
              ;;
            run_groupdocs_cloud)
              value="${{ inputs.run_groupdocs_cloud }}"
              ;;
            *)
              value="false"
              ;;
          esac

          echo "run_this=${value}" >> "$GITHUB_OUTPUT"

      - name: Checkout repository
        if: ${{ steps.select.outputs.run_this == 'true' }}
        uses: actions/checkout@v4

      - name: Set up Python
        if: ${{ steps.select.outputs.run_this == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Random delay (jitter the daily run)
        if: ${{ github.event_name == 'schedule' || inputs.skip_jitter == false }}
        run: |
          delay=$(( RANDOM % 3600 ))
          echo "Sleeping for ${delay}s to randomize today's start time..."
          sleep "$delay"

      - name: Fetch blog content
        if: ${{ steps.select.outputs.run_this == 'true' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          ref: ${{ matrix.default_branch }}
          path: ${{ matrix.path }}
          fetch-depth: 1
          token: ${{ secrets.BLOG_REPOS_TOKEN || github.token }}

      - name: Checkout optimizer agent
        if: ${{ steps.select.outputs.run_this == 'true' }}
        uses: actions/checkout@v4
        with:
          repository: conholdate/blog-optimization-agent
          token: ${{ secrets.BLOG_OPTIMIZER_REPO_TOKEN }}
          path: optimizer-agent
          fetch-depth: 1

      - name: Install dependencies
        if: ${{ steps.select.outputs.run_this == 'true' }}
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r optimizer-agent/requirements.txt pandas

      - name: "Preflight: verify optimizer secrets"
        if: ${{ steps.select.outputs.run_this == 'true' }}
        env:
          PROFESSIONALIZE_API_KEY: ${{ secrets.PROFESSIONALIZE_API_KEY }}
          PROFESSIONALIZE_BASE_URL: ${{ secrets.PROFESSIONALIZE_BASE_URL }}
          PROFESSIONALIZE_LLM_MODEL: ${{ secrets.PROFESSIONALIZE_LLM_MODEL }}
          PROFESSIONALIZE_EMBEDDING_MODEL: ${{ secrets.PROFESSIONALIZE_EMBEDDING_MODEL }}
        run: |
          missing=0

          if [ -z "$PROFESSIONALIZE_API_KEY" ]; then
            echo "Missing secret: PROFESSIONALIZE_API_KEY"
            missing=1
          fi

          if [ -z "$PROFESSIONALIZE_BASE_URL" ]; then
            echo "Missing secret: PROFESSIONALIZE_BASE_URL"
            missing=1
          fi

          if [ -z "$PROFESSIONALIZE_LLM_MODEL" ]; then
            echo "Missing secret: PROFESSIONALIZE_LLM_MODEL"
            missing=1
          fi

          if [ "$missing" -ne 0 ]; then
            echo "One or more required secrets are missing. Set them in repo Settings -> Secrets and variables -> Actions."
            exit 1
          fi

      - name: Run optimizer
        if: ${{ steps.select.outputs.run_this == 'true' }}
        env:
          PROFESSIONALIZE_API_KEY: ${{ secrets.PROFESSIONALIZE_API_KEY }}
          PROFESSIONALIZE_BASE_URL: ${{ secrets.PROFESSIONALIZE_BASE_URL }}
          PROFESSIONALIZE_LLM_MODEL: ${{ secrets.PROFESSIONALIZE_LLM_MODEL }}
          PROFESSIONALIZE_EMBEDDING_MODEL: ${{ secrets.PROFESSIONALIZE_EMBEDDING_MODEL }}
          BLOG_OPTIMIZER_API_TOKEN: ${{ secrets.BLOG_OPTIMIZER_API_TOKEN }}
          BLOGS_TEAM_TOKEN: ${{ secrets.BLOGS_TEAM_TOKEN }}
        working-directory: optimizer-agent
        run: |
          python blog_optimizer_agent.py --brand ${{ matrix.brand }} --sourcepath "${{ github.workspace }}/${{ matrix.path }}"

      - name: Commit optimized content back to blog repo
        if: ${{ steps.select.outputs.run_this == 'true' }}
        env:
          BLOG_REPOS_TOKEN: ${{ secrets.BLOG_REPOS_TOKEN }}
        run: |
          if [ -z "$BLOG_REPOS_TOKEN" ]; then
            echo "BLOG_REPOS_TOKEN not set; skipping push back to ${GITHUB_REPOSITORY}."
            exit 0
          fi

          git -C "${{ matrix.path }}" config user.name "optimizer-agent"
          git -C "${{ matrix.path }}" config user.email "optimizer-agent@users.noreply.github.com"
          git -C "${{ matrix.path }}" add -A

          if git -C "${{ matrix.path }}" diff --cached --quiet; then
            echo "No content changes to commit for ${{ matrix.brand }}."
            exit 0
          fi

          git -C "${{ matrix.path }}" commit -m "Blog Optimization Agent"
          git -C "${{ matrix.path }}" pull --rebase origin "${{ matrix.default_branch }}"
          git -C "${{ matrix.path }}" push origin "HEAD:${{ matrix.default_branch }}"
